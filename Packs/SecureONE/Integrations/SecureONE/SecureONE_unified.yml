category: Utilities
commonfields:
  id: SecureONE
  version: -1
configuration:
- defaultvalue: https://51a07c94-8790-474d-b51d-cf6ff4cdb0ed.mock.pstmn.io/
  display: Your server URL
  name: url
  required: true
  type: 0
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
defaultMapperIn: 'null'
defaultMapperOut: 'null'
defaultclassifier: 'null'
description: Analyze jita accounts on a compromised machine and further analyze risk
  the accounts pose to the organization
detaileddescription: |-
  ## BaseIntegration Help

  Markdown file for integration configuration  help snippet. In this file add:
  - Brief information about how to retrieve the API key of your product
  - Other useful information on how to configure your integration in XSOAR

  Since this is a Markdown file, we encourage you to use MD formatting for sections, sub-sections, lists, etc.
display: SecureONE
name: SecureONE
script:
  commands:
  - arguments:
    - default: false
      description: Name of the machine
      isArray: false
      name: machine_name
      required: true
      secret: false
    - default: false
      description: Machine domain (Could be left blank if none)
      isArray: false
      name: domain_name
      required: false
      secret: false
    deprecated: false
    description: Get all accounts on the compromised machine
    execution: false
    name: secureone-get-machine-risk
    outputs:
    - contextPath: Secureone.Sessions.machine_id
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.machine_name
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts
      description: List of accounts with JITA sessions
      type: Array
    - contextPath: Secureone.Sessions.accounts.account_name
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.account_id
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.sid
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.account_history
      description: Machine Id on which search is performed
      type: Array
    - contextPath: Secureone.Sessions.accounts.access_history.access_type
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.access_history.access_start_date
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.access_history.access_end_date
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.access_history.session_id
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.access_history.session_active
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.access_via
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.group_path
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.list_access_type
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.list_access_start_date
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.list_access_end_date
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.list_jita_active
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.workstation_count
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Sessions.accounts.server_count
      description: Machine Id on which search is performed
      type: String
  - arguments:
    - default: false
      description: Account name to be analysed
      isArray: false
      name: account_name
      required: true
      secret: false
    - default: false
      description: Account Domain (Blank if not present)
      isArray: false
      name: domain_name
      required: true
      secret: false
    deprecated: false
    description: Get account risk of the organization
    execution: false
    name: secureone-get-account-risk
    outputs:
    - contextPath: Secureone.Access.account_id
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.sid
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.account_name
      description: List of accounts with JITA sessions
      type: Array
    - contextPath: Secureone.Access.machines.system_name
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.machines.system_type
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.machines.system_id
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.machines.access_type
      description: Machine Id on which search is performed
      type: Array
    - contextPath: Secureone.Access.machines.access_history.access_type
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.machines.access_history.access_start_date
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.machines.access_history.access_end_date
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.machines.access_history.session_id
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.machines.access_history.session_active
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.groups.group_name
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.groups.group_id
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.groups.description
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.groups.domain_fqdn
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.groups.domain_name
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.groups.objectSid
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.groups.domainandname
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.Access.groups.machine_count
      description: Machine Id on which search is performed
      type: String
  - arguments:
    - default: false
      description: Group Name
      isArray: false
      name: group
      required: true
      secret: false
    - default: false
      description: Group Domain (Blank if not present)
      isArray: false
      name: domain_name
      required: true
      secret: false
    deprecated: false
    description: Get the risk of impacted group
    execution: false
    name: secureone-get-group-risk
    outputs:
    - contextPath: Secureone.GroupAccess.group_id
      description: Name of the account
      type: String
    - contextPath: Secureone.GroupAccess.group_name
      description: Group Name
      type: String
    - contextPath: Secureone.GroupAccess.description
      description: Group Description
      type: Array
    - contextPath: Secureone.GroupAccess.accounts.account_name
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.accounts.account_type
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.accounts.account_id
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.accounts.sid
      description: Machine Id on which search is performed
      type: Array
    - contextPath: Secureone.GroupAccess.accounts.last_access_type
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.accounts.last_access_start_time
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.accounts.last_access_end_time
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.accounts.last_jita_active
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.accounts.workstation_count
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.accounts.server_count
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.accounts.access_via
      description: Machine Id on which search is performed
      type: Array
    - contextPath: Secureone.GroupAccess.accounts.group_list
      description: Machine Id on which search is performed
      type: Array
    - contextPath: Secureone.GroupAccess.nested_groups.group_name
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.nested_groups.group_id
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.nested_groups.description
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.nested_groups.domain_fqdn
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.nested_groups.domain_name
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.nested_groups.objectSid
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.nested_groups.domainandname
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.nested_groups.machine_count
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.nested_groups.user_count
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.machines.system_name
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.machines.system_type
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.machines.system_id
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.machines.access_type
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.machines.access_date
      description: Machine Id on which search is performed
      type: String
    - contextPath: Secureone.GroupAccess.machines.access_history
      description: Machine Id on which search is performed
      type: Array
  dockerimage: demisto/python3:3.9.1.15759
  feed: false
  isfetch: false
  longRunning: false
  longRunningPort: false
  runonce: false
  script: |-
    """Base Integration for Cortex XSOAR (aka Demisto)

    This is an empty Integration with some basic structure according
    to the code conventions.

    MAKE SURE YOU REVIEW/REPLACE ALL THE COMMENTS MARKED AS "TODO"

    Developer Documentation: https://xsoar.pan.dev/docs/welcome
    Code Conventions: https://xsoar.pan.dev/docs/integrations/code-conventions
    Linting: https://xsoar.pan.dev/docs/integrations/linting

    This is an empty structure file. Check an example at;
    https://github.com/demisto/content/blob/master/Packs/HelloWorld/Integrations/HelloWorld/HelloWorld.py

    """


      # noqa # pylint: disable=unused-wildcard-import
      # noqa

    import requests
    import traceback
    from typing import Dict, Any

    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()  # pylint: disable=no-member


    ''' CONSTANTS '''

    DATE_FORMAT = '%Y-%m-%dT%H:%M:%SZ'  # ISO8601 format with UTC, default in XSOAR

    ''' CLIENT CLASS '''


    class Client(BaseClient):
        """Client class to interact with the service API

        This Client implements API calls, and does not contain any XSOAR logic.
        Should only do requests and return data.
        It inherits from BaseClient defined in CommonServer Python.
        Most calls use _http_request() that handles proxy, SSL verification, etc.
        For this  implementation, no special attributes defined
        """

        def get_sessions_for_machine(self, machine_name: str, domain_name: str ) -> Dict[str, Any]:
            api = f'/risk/machine'
            print(self._base_url)
            response = self._http_request(
                method='GET',
                url_suffix=api,
                params={
                    'machine_name': machine_name,
                    'domain_name': domain_name
                }
            )
            return response

        def get_sessions_for_account(self, account: str) -> Dict[str, Any]:
            api = f'/risk/account'
            response = self._http_request(
                method='GET',
                url_suffix=api,
                params={
                    'tstart': '1617910914',
                    'tend': '1617910920',
                    'account_name': account,
                    'domain_name': "trash",
                    'users': True,
                    'groups': True,
                    'accounts': True,
                    'persistent': True,
                    'jita': True,
                    'access_history': True
                }
            )
            return response

        def get_sessions_for_group(self, group: str) -> Dict[str, Any]:
            api = f'/risk/group'
            response = self._http_request(
                method='GET',
                url_suffix=api,
                params={
                    'tstart': '1617910914',
                    'tend': '1617910920',
                    'group_name': group,
                    'domain_name': "trash",
                    'users': True,
                    'groups': True,
                    'accounts': True,
                    'persistent': True,
                    'jita': True,
                    'access_history': True
                }
            )
            return response


    ''' HELPER FUNCTIONS '''

    # TODO: ADD HERE ANY HELPER FUNCTION YOU MIGHT NEED (if any)

    ''' COMMAND FUNCTIONS '''


    def execute_test_module_command(client: Client) -> str:
        """Tests API connectivity and authentication'

        Returning 'ok' indicates that the integration works like it is supposed to.
        Connection to the service is successful.
        Raises exceptions if something goes wrong.

        :type client: ``Client``
        :param Client: client to use

        :return: 'ok' if test passed, anything else will fail the test.
        :rtype: ``str``
        """

        message: str = ''
        try:
            # TODO: ADD HERE some code to test connectivity and authentication to your service.
            # This  should validate all the inputs given in the integration configuration panel,
            # either manually or by using an API that uses them.
            message = 'ok'
        except DemistoException as e:
            if 'Forbidden' in str(e) or 'Authorization' in str(e):  # TODO: make sure you capture authentication errors
                message = 'Authorization Error: make sure API Key is correctly set'
            else:
                raise e
        return message


    def execute_risk_for_machine_command(client: Client, machine_name: str, domain_name: str) -> CommandResults:
        if not machine_name:
            raise ValueError('machine name not specified')

        if not domain_name:
            raise ValueError('machine name not specified')

        # Call the Client function and get the raw response
        result = client.get_sessions_for_machine(machine_name, domain_name)

        return CommandResults(
            outputs_prefix='Secureone.Sessions',
            outputs_key_field='machine_id',
            outputs=result,
        )


    def execute_risk_for_account_command(client: Client, account: str) -> CommandResults:
        if not account:
            raise ValueError('account name not specified')

        # Call the Client function and get the raw response
        result = client.get_sessions_for_account(account)

        return CommandResults(
            outputs_prefix='Secureone.Access',
            outputs_key_field='account_id',
            outputs=result,
        )


    def execute_risk_for_group_command(client: Client, group: str) -> CommandResults:
        if not group:
            raise ValueError('group name not specified')

        # Call the Client function and get the raw response
        result = client.get_sessions_for_group(group)

        return CommandResults(
            outputs_prefix='Secureone.GroupAccess',
            outputs_key_field='group_id',
            outputs=result,
        )

    # TODO: ADD additional command functions that translate XSOAR inputs/outputs to Client


    ''' MAIN FUNCTION '''


    def main() -> None:
        """main function, parses params and runs command functions

        :return:
        :rtype:
        """

        # TODO: make sure you properly handle authentication
        # api_key = demisto.params().get('apikey')

        # get the service API url
        base_url = demisto.params()['url']

        # if your Client class inherits from BaseClient, SSL verification is
        # handled out of the box by it, just pass ``verify_certificate`` to
        # the Client constructor
        verify_certificate = not demisto.params().get('insecure', False)

        # if your Client class inherits from BaseClient, system proxy is handled
        # out of the box by it, just pass ``proxy`` to the Client constructor
        proxy = demisto.params().get('proxy', False)

        demisto.debug(f'Command being called is {demisto.command()}')
        try:

            # TODO: Make sure you add the proper headers for authentication
            # (i.e. "Authorization": {api key})
            headers: Dict = {}

            client = Client(
                base_url=base_url,
                verify=verify_certificate,
                headers=headers,
                proxy=proxy)

            command_methods = {
                'test-module': lambda: execute_test_module_command(client),
                'secureone-get-machine-risk': lambda: execute_risk_for_machine_command(client, demisto.params().get('machine_name','TRASH'), demisto.params().get('domain_name', 'RTEST')),
                'secureone-get-account-risk': lambda: execute_risk_for_account_command(client, demisto.args.get("account_name")),
                'secureone-get-group-risk': lambda: execute_risk_for_group_command(client, demisto.args.get("group_name"))
            }
            command_method = command_methods.get(demisto.command())

            if not command_method:
                raise DemistoException(f'command not recognised - {demisto.command()}')

            result = command_method()
            if result:
                return_results(result)

        # Log exceptions and return errors
        except Exception as e:
            demisto.error(traceback.format_exc())  # print the traceback
            return_error(f'Failed to execute {demisto.command()} command.\nError:\n{str(e)}')


    ''' ENTRY POINT '''


    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()
  subtype: python3
  type: python
image: data:image/png;base64,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
tests:
- No tests (auto formatted)
fromversion: 5.5.0
